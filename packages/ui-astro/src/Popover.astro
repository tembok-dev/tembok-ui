---
import { cx } from "./utils/variants";

const {
  openOn = "click",
  side = "auto",
  align = "center",
  offset = 10,
  edgePad = 16,
  panelClassName,
  closeOnSelect = true,
  role = "dialog",
  bgColor,
  textColor,
  borderColor,
  themeScoped = true,
  zIndex,
} = Astro.props;

const triggerId =
  Astro.props.triggerId ||
  `tmbk-popover-trigger-${Math.random().toString(36).slice(2)}`;
const panelId =
  Astro.props.panelId ||
  `tmbk-popover-panel-${Math.random().toString(36).slice(2)}`;

const panelClass = cx("tmbk-popover", themeScoped && "tmbk-theme", panelClassName);

const styleVars = {};
if (bgColor) styleVars["--tmbk-bg"] = bgColor;
if (textColor) styleVars["--tmbk-fg"] = textColor;
if (borderColor) styleVars["--tmbk-border"] = borderColor;
if (zIndex != null) styleVars["z-index"] = String(zIndex);

const styleAttr = Object.entries(styleVars)
  .map(([key, value]) => `${key}:${value}`)
  .join(";");
---

<div
  data-popover-root
  data-open-on={openOn}
  data-offset={offset}
  data-edgepad={edgePad}
  data-sidepref={side}
  data-align={align}
  data-close-on-select={String(closeOnSelect)}
  class="tmbk-popover-root"
>
  <span
    data-popover-trigger
    id={triggerId}
    aria-haspopup={role}
    aria-expanded="false"
    aria-controls={panelId}
    class="tmbk-popover-trigger"
  >
    <slot name="trigger" />
  </span>

  <div
    data-popover-panel
    id={panelId}
    role={role}
    aria-labelledby={triggerId}
    tabindex="-1"
    class={panelClass}
    data-open="false"
    data-side="down"
    data-align={align}
    style={styleAttr || undefined}
  >
    <div data-popover-arrow class="tmbk-popover-arrow" />
    <slot />
  </div>
</div>

<script is:inline>
  (() => {
    if (window.__tembokPopoverBooted) return;
    window.__tembokPopoverBooted = true;

    function initPopover(root) {
      if (root.hasAttribute("data-popover-ready")) return;
      root.setAttribute("data-popover-ready", "true");

      const trigger = root.querySelector("[data-popover-trigger]");
      const panel = root.querySelector("[data-popover-panel]");
      const arrow = root.querySelector("[data-popover-arrow]");

      if (!trigger || !panel || !arrow) return;

      const openOn = root.getAttribute("data-open-on") || "click";
      const OFFSET = Number(root.getAttribute("data-offset") || 10);
      const EDGE = Number(root.getAttribute("data-edgepad") || 16);
      const SIDE_PREF = root.getAttribute("data-sidepref") || "auto";
      const ALIGN = root.getAttribute("data-align") || "center";
      const CLOSE_ON_SELECT =
        root.getAttribute("data-close-on-select") !== "false";

      let open = false;
      let tOpen;
      let tClose;

      function setOpen(next) {
        if (open === next) return;
        open = next;
        trigger.setAttribute("aria-expanded", String(open));
        panel.setAttribute("data-open", open ? "true" : "false");
        if (open) {
          position();
          document.addEventListener("click", onDocClick, true);
          document.addEventListener("keydown", onKey, true);
          window.addEventListener("resize", onWin, { passive: true });
          window.addEventListener("scroll", onWin, { passive: true });
        } else {
          document.removeEventListener("click", onDocClick, true);
          document.removeEventListener("keydown", onKey, true);
          window.removeEventListener("resize", onWin);
          window.removeEventListener("scroll", onWin);
        }
      }

      function onDocClick(e) {
        const t = e.target;
        if (!(t instanceof Element)) return;
        if (!root.contains(t) && !panel.contains(t)) setOpen(false);
      }

      function onKey(e) {
        if (e.key === "Escape") setOpen(false);
      }

      function onWin() {
        if (open) position();
      }

      function position() {
        const actualTrigger =
          trigger.querySelector("button, a, [role='button']") ||
          trigger.firstElementChild ||
          trigger;

        const tr = actualTrigger.getBoundingClientRect();
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        const w = panel.offsetWidth;
        const contentH = panel.scrollHeight;

        const spaceBelow = vh - tr.bottom - EDGE;
        const spaceAbove = tr.top - EDGE;

        let finalSide = "down";
        if (SIDE_PREF === "up") finalSide = "up";
        else if (SIDE_PREF === "down") finalSide = "down";
        else finalSide = spaceBelow < contentH && spaceAbove > spaceBelow ? "up" : "down";

        const allowed =
          finalSide === "down"
            ? Math.max(0, vh - EDGE - (tr.bottom + OFFSET))
            : Math.max(0, tr.top - OFFSET - EDGE);

        const finalH = Math.min(contentH, allowed);
        panel.style.maxHeight = finalH < contentH ? `${Math.floor(finalH)}px` : "";
        panel.style.overflowY = finalH < contentH ? "auto" : "";

        let top =
          finalSide === "down" ? tr.bottom + OFFSET : tr.top - OFFSET - finalH;
        let leftCenter = tr.left + tr.width / 2;

        let left =
          ALIGN === "start"
            ? tr.left
            : ALIGN === "end"
            ? tr.right - w
            : leftCenter - w / 2;

        left = Math.max(EDGE, Math.min(left, vw - EDGE - w));
        top = Math.max(EDGE, Math.min(top, vh - EDGE - finalH));

        panel.style.left = `${left}px`;
        panel.style.top = `${top}px`;
        panel.setAttribute("data-side", finalSide);
        panel.setAttribute("data-align", ALIGN);

        const arrowSize = 12;
        const midX = tr.left + tr.width / 2;
        const arrowX = Math.max(
          8,
          Math.min(w - 8 - arrowSize, midX - left - arrowSize / 2)
        );
        arrow.style.left = `${arrowX}px`;

        if (finalSide === "down") {
          arrow.style.top = `-${arrowSize / 2}px`;
          arrow.style.bottom = "";
          arrow.style.transform = "rotate(45deg)";
        } else {
          arrow.style.bottom = `-${arrowSize / 2}px`;
          arrow.style.top = "";
          arrow.style.transform = "rotate(225deg)";
        }
      }

      if (openOn === "click") {
        trigger.addEventListener("click", (e) => {
          e.preventDefault();
          setOpen(!open);
        });
      } else {
        const enter = () => {
          clearTimeout(tClose);
          tOpen = setTimeout(() => setOpen(true), 80);
        };
        const leave = () => {
          clearTimeout(tOpen);
          tClose = setTimeout(() => setOpen(false), 120);
        };
        trigger.addEventListener("mouseenter", enter);
        trigger.addEventListener("mouseleave", leave);
        panel.addEventListener("mouseenter", enter);
        panel.addEventListener("mouseleave", leave);
        trigger.addEventListener("click", () => setOpen(!open));
      }

      if (CLOSE_ON_SELECT) {
        panel.addEventListener("click", (e) => {
          const el =
            e.target instanceof Element
              ? e.target.closest("a,button,[role='menuitem']")
              : null;
          if (!el) return;
          const wants = el.getAttribute("data-close-popover");
          if (wants === "false") return;
          setOpen(false);
        });
      }
    }

    const initAll = () => {
      document
        .querySelectorAll("[data-popover-root]:not([data-popover-ready])")
        .forEach((el) => initPopover(el));
    };

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initAll, { once: true });
    } else {
      initAll();
    }

    const mo = new MutationObserver(() => initAll());
    mo.observe(document.documentElement, { childList: true, subtree: true });
  })();
</script>
