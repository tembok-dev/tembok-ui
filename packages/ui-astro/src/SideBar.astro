---
import { cx } from "./utils/variants";

const {
  id = "sidebar",
  side = "right",
  width,
  maxWidth,
  panelClassName,
  overlayClassName,
  showClose = true,
  closeAriaLabel = "Close menu",
  defaultOpen = false,
  closeOnLinkClick = false,
  closeOnEscape = true,
  closeOnOverlayClick = true,
  bgColor,
  textColor,
  borderColor,
  backdrop,
  themeScoped = true,
} = Astro.props;

const vars = {};
if (bgColor) vars["--tmbk-bg"] = bgColor;
if (textColor) vars["--tmbk-fg"] = textColor;
if (borderColor) vars["--tmbk-border"] = borderColor;
if (backdrop) vars["--tmbk-backdrop"] = backdrop;
if (width) vars["--tmbk-sidebar-w"] = width;
if (maxWidth) vars["--tmbk-sidebar-maxw"] = maxWidth;

const styleAttr = Object.entries(vars)
  .map(([key, value]) => `${key}:${value}`)
  .join(";");

const overlayClass = cx(
  "tmbk-sidebar-overlay",
  themeScoped && "tmbk-theme",
  overlayClassName
);
const panelClass = cx(
  "tmbk-sidebar",
  themeScoped && "tmbk-theme",
  panelClassName
);
---

<div data-sidebar-root data-sidebar-id={id}>
  <div
    class={overlayClass}
    data-open={defaultOpen ? "true" : "false"}
    data-sidebar-overlay
    aria-hidden="true"
    style={styleAttr || undefined}
  />

  <aside
    class={panelClass}
    data-open={defaultOpen ? "true" : "false"}
    data-side={side}
    data-sidebar-panel
    role="dialog"
    aria-modal="true"
    aria-hidden={defaultOpen ? "false" : "true"}
    style={styleAttr || undefined}
  >
    <div class="tmbk-sidebar-shell">
      <div class="tmbk-sidebar-header" data-side={side}>
        <div class="tmbk-sidebar-header-row">
          <slot name="header">
            {showClose && (
              <button
                data-sidebar-close-button
                aria-label={closeAriaLabel}
                class="tmbk-sidebar-close"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M18 6 6 18" />
                  <path d="m6 6 12 12" />
                </svg>
              </button>
            )}
          </slot>
        </div>
      </div>

      <div class="tmbk-sidebar-content" data-sidebar-content>
        <slot />
      </div>
    </div>
  </aside>
</div>

<script is:inline define:vars={{ id, closeOnLinkClick, closeOnEscape, closeOnOverlayClick }}>
  (() => {
    const root = document.querySelector('[data-sidebar-id="' + id + '"]');
    if (!root) return;

    const overlay = root.querySelector("[data-sidebar-overlay]");
    const panel = root.querySelector("[data-sidebar-panel]");
    if (!overlay || !panel) return;

    const isOpen = () => panel.getAttribute("data-open") === "true";
    const setOpen = (next) => {
      overlay.setAttribute("data-open", next ? "true" : "false");
      panel.setAttribute("data-open", next ? "true" : "false");
      panel.setAttribute("aria-hidden", next ? "false" : "true");

      const body = document.body;
      if (next) {
        body.dataset.tmbkSidebarScroll = body.style.overflow || "";
        body.style.overflow = "hidden";
      } else if (body.dataset.tmbkSidebarScroll !== undefined) {
        body.style.overflow = body.dataset.tmbkSidebarScroll;
        delete body.dataset.tmbkSidebarScroll;
      }
    };

    const close = () => setOpen(false);

    if (closeOnOverlayClick) {
      overlay.addEventListener("click", close, true);
    }

    panel.addEventListener(
      "click",
      (e) => {
        const t = e.target;
        if (!(t instanceof Element)) return;
        if (t.closest("[data-sidebar-close-button],[data-close-menu]")) {
          close();
          return;
        }
        if (closeOnLinkClick && t.closest("a")) close();
      },
      true
    );

    if (closeOnEscape) {
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && isOpen()) {
          e.preventDefault();
          close();
        }
      });
    }

    document.addEventListener(
      "click",
      (e) => {
        const t = e.target;
        if (!(t instanceof Element)) return;
        const opener = t.closest("[data-sidebar-open],[data-sidebar-close],[data-sidebar-toggle]");
        if (!opener) return;

        const openId = opener.getAttribute("data-sidebar-open");
        const closeId = opener.getAttribute("data-sidebar-close");
        const toggleId = opener.getAttribute("data-sidebar-toggle");
        const tgt = openId || closeId || toggleId;
        if (tgt !== id) return;

        if (openId) setOpen(true);
        if (closeId) setOpen(false);
        if (toggleId) setOpen(!isOpen());

        if (opener.tagName === "A" && opener.getAttribute("href") === "#") {
          e.preventDefault();
        }
      },
      true
    );
  })();
</script>
